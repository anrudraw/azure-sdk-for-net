parameters:
- name: Clouds
  type: string
  default: 'AzureCloud'
- name: Platforms
  type: object
  default: []
- name: AdditionalParameters
  type: object
  default: []
- name: Location
  type: string
- name: CloudConfig
  type: object
  default:
    AzureCloud:
      SubscriptionConfiguration: $(sub-config-azure-cloud-test-resources-test)
    #  AzureCloud_Preview:
    #    SubscriptionConfiguration: $(sub-config-azure-cloud-test-resources-preview-test)
    #  AzureCloud_Canary:
    #    SubscriptionConfiguration: $(sub-config-azure-cloud-test-resources-preview-test)
    #    Location: 'eastus2euap'
    #  AzureUsGovCloud:
    #    SubscriptionConfiguration: $(sub-config-gov-test-resources-test)
    #  AzureChinaCloud:
    #    SubscriptionConfiguration: $(sub-config-cn-test-resources-test)


stages:
  - ${{ each cloud in parameters.CloudConfig }}:
    - stage: ${{ cloud.key }}
      condition: or(eq(variables['Build.Reason'], 'Manual'), contains('${{ parameters.Clouds }}', '${{ cloud.key }}'))
      dependsOn: []
      jobs:
      - template: ../jobs/archetype-sdk-tests-platforms.yml
        parameters:
          AdditionalParameters: ${{ parameters.AdditionalParameters }}
          Platforms:
            ${{ each platform in parameters.Platforms }}:
              ${{ if contains(cloud.key, coalesce(platform.value.SupportedClouds, join(',', parameters.CloudConfig))) }}:
                ${{ platform.key }}: ${{ platform.value }}
          CloudConfig:
            DisplayName: ${{ cloud.key }}
            SubscriptionConfiguration: ${{ cloud.value.SubscriptionConfiguration }}
            Location: ${{ cloud.value.Location }}
